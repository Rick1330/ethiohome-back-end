doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1.0")
    title Password Reset - Ethio Home
    style.
      body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f4f4f9; }
      .container { text-align: center; padding: 40px; border-radius: 8px; background-color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.1); width: 400px; }
      h1 { color: #333; }
      p { color: #666; font-size: 1.1rem; }
      .success { color: #28a745; }
      .error { color: #dc3545; }
      form { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
      input { padding: 10px; border-radius: 4px; border: 1px solid #ccc; font-size: 1rem; }
      button { padding: 12px; border-radius: 4px; border: none; background-color: #4a6bff; color: white; font-size: 1rem; cursor: pointer; }
      button:hover { background-color: #3a5bef; }
  body
    .container
      h1 Ethio Home
      p#status Please enter your new password below.
      form#resetForm
        input(type="password", id="password", name="password", placeholder="New Password", required, minlength="8")
        input(type="password", id="passwordConfirm", name="passwordConfirm", placeholder="Confirm New Password", required)
        button(type="submit") Reset Password

    script.
      document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('resetForm');
        const statusEl = document.getElementById('status');
        const token = window.location.pathname.split('/').pop();
        const frontendUrl = !{JSON.stringify(frontendUrl)} || 'http://localhost:5173';

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          statusEl.textContent = 'Resetting your password...';
          statusEl.className = '';

          const password = document.getElementById('password').value;
          const passwordConfirm = document.getElementById('passwordConfirm').value;

          if (password.length < 8) {
            statusEl.textContent = 'Password must be at least 8 characters long.';
            statusEl.className = 'error';
            return;
          }

          if (password !== passwordConfirm) {
            statusEl.textContent = 'Passwords do not match.';
            statusEl.className = 'error';
            return;
          }

          try {
            const response = await fetch(`/api/v1/users/resetPassword/${token}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ password, passwordConfirm })
            });

            const data = await response.json();

            if (response.ok) {
              statusEl.textContent = 'Password reset successfully! You will be redirected shortly.';
              statusEl.className = 'success';
              form.style.display = 'none';
              setTimeout(() => {
                window.location.href = `${frontendUrl}/login?reset=true`;
              }, 3000);
            } else {
              throw new Error(data.message || 'Password reset failed. The token may be invalid or expired.');
            }
          } catch (error) {
            statusEl.textContent = error.message;
            statusEl.className = 'error';
          }
        });
      });
